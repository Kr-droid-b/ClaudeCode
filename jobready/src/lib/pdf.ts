import { PDFDocument, rgb, StandardFonts } from 'pdf-lib'

interface CVData {
  summary: string
  experience: string[]
  skills: string[]
  education: string[]
  certifications: string[]
}

export async function generateCVPdf(data: CVData): Promise<Buffer> {
  const doc = await PDFDocument.create()
  const font = await doc.embedFont(StandardFonts.Helvetica)
  const boldFont = await doc.embedFont(StandardFonts.HelveticaBold)
  const fontSize = 10
  const headerSize = 14
  const sectionSize = 12
  const lineHeight = 14
  const margin = 50
  const navy = rgb(0.1, 0.15, 0.35)
  const dark = rgb(0.15, 0.15, 0.15)

  let page = doc.addPage([595, 842]) // A4
  let y = 792

  function addNewPage() {
    page = doc.addPage([595, 842])
    y = 792
  }

  function checkPageBreak(neededHeight: number) {
    if (y - neededHeight < margin) {
      addNewPage()
    }
  }

  function drawText(text: string, x: number, size: number, color: typeof navy, useBold = false) {
    const f = useBold ? boldFont : font
    const maxWidth = 595 - margin * 2
    const words = text.split(' ')
    let line = ''

    for (const word of words) {
      const testLine = line ? `${line} ${word}` : word
      const width = f.widthOfTextAtSize(testLine, size)
      if (width > maxWidth && line) {
        checkPageBreak(lineHeight)
        page.drawText(line, { x, y, size, font: f, color })
        y -= lineHeight
        line = word
      } else {
        line = testLine
      }
    }
    if (line) {
      checkPageBreak(lineHeight)
      page.drawText(line, { x, y, size, font: f, color })
      y -= lineHeight
    }
  }

  function drawSection(title: string) {
    y -= 8
    checkPageBreak(30)
    page.drawText(title.toUpperCase(), {
      x: margin,
      y,
      size: sectionSize,
      font: boldFont,
      color: navy,
    })
    y -= 4
    page.drawLine({
      start: { x: margin, y },
      end: { x: 595 - margin, y },
      thickness: 1,
      color: navy,
    })
    y -= lineHeight
  }

  // Header
  page.drawText('CURRICULUM VITAE', {
    x: margin,
    y,
    size: headerSize,
    font: boldFont,
    color: navy,
  })
  y -= 6
  page.drawLine({
    start: { x: margin, y },
    end: { x: 595 - margin, y },
    thickness: 2,
    color: navy,
  })
  y -= lineHeight + 4

  // Summary
  drawSection('Professional Summary')
  drawText(data.summary, margin, fontSize, dark)

  // Experience
  drawSection('Experience')
  for (const entry of data.experience) {
    drawText(entry, margin, fontSize, dark)
    y -= 6
  }

  // Skills
  drawSection('Skills')
  const skillsText = data.skills.join('  •  ')
  drawText(skillsText, margin, fontSize, dark)

  // Education
  if (data.education.length > 0) {
    drawSection('Education')
    for (const entry of data.education) {
      drawText(entry, margin, fontSize, dark)
      y -= 4
    }
  }

  // Certifications
  if (data.certifications.length > 0) {
    drawSection('Certifications')
    for (const entry of data.certifications) {
      drawText(entry, margin, fontSize, dark)
      y -= 4
    }
  }

  // Footer
  y -= 20
  checkPageBreak(20)
  page.drawText('Generated by JobReady.bg — ATS Optimized', {
    x: margin,
    y,
    size: 8,
    font,
    color: rgb(0.5, 0.5, 0.5),
  })

  const pdfBytes = await doc.save()
  return Buffer.from(pdfBytes)
}

export async function generateCoverLetterPdf(text: string): Promise<Buffer> {
  const doc = await PDFDocument.create()
  const font = await doc.embedFont(StandardFonts.Helvetica)
  const boldFont = await doc.embedFont(StandardFonts.HelveticaBold)
  const navy = rgb(0.1, 0.15, 0.35)
  const dark = rgb(0.15, 0.15, 0.15)

  let page = doc.addPage([595, 842])
  let y = 780
  const margin = 60
  const fontSize = 11
  const lineHeight = 16

  // Header
  page.drawText('COVER LETTER', {
    x: margin,
    y,
    size: 14,
    font: boldFont,
    color: navy,
  })
  y -= 6
  page.drawLine({
    start: { x: margin, y },
    end: { x: 595 - margin, y },
    thickness: 1.5,
    color: navy,
  })
  y -= 24

  // Body
  const paragraphs = text.split('\n').filter((p) => p.trim())
  for (const para of paragraphs) {
    const maxWidth = 595 - margin * 2
    const words = para.split(' ')
    let line = ''

    for (const word of words) {
      const testLine = line ? `${line} ${word}` : word
      const width = font.widthOfTextAtSize(testLine, fontSize)
      if (width > maxWidth && line) {
        if (y < 60) {
          page = doc.addPage([595, 842])
          y = 780
        }
        page.drawText(line, { x: margin, y, size: fontSize, font, color: dark })
        y -= lineHeight
        line = word
      } else {
        line = testLine
      }
    }
    if (line) {
      if (y < 60) {
        page = doc.addPage([595, 842])
        y = 780
      }
      page.drawText(line, { x: margin, y, size: fontSize, font, color: dark })
      y -= lineHeight
    }
    y -= 8 // paragraph spacing
  }

  // Footer
  y = 40
  page.drawText('Generated by JobReady.bg', {
    x: margin,
    y,
    size: 8,
    font,
    color: rgb(0.5, 0.5, 0.5),
  })

  const pdfBytes = await doc.save()
  return Buffer.from(pdfBytes)
}

export async function generateLinkedInPdf(data: {
  headline: string
  about: string
  experience: string[]
}): Promise<Buffer> {
  const doc = await PDFDocument.create()
  const font = await doc.embedFont(StandardFonts.Helvetica)
  const boldFont = await doc.embedFont(StandardFonts.HelveticaBold)
  const navy = rgb(0.1, 0.15, 0.35)
  const dark = rgb(0.15, 0.15, 0.15)
  const linkedInBlue = rgb(0.0, 0.47, 0.71)

  let page = doc.addPage([595, 842])
  let y = 780
  const margin = 50
  const fontSize = 10
  const lineHeight = 14

  function checkPageBreak() {
    if (y < 60) {
      page = doc.addPage([595, 842])
      y = 780
    }
  }

  function drawWrapped(text: string, x: number, size: number, color: typeof navy, f = font) {
    const maxWidth = 595 - margin * 2
    const words = text.split(' ')
    let line = ''
    for (const word of words) {
      const testLine = line ? `${line} ${word}` : word
      if (f.widthOfTextAtSize(testLine, size) > maxWidth && line) {
        checkPageBreak()
        page.drawText(line, { x, y, size, font: f, color })
        y -= lineHeight
        line = word
      } else {
        line = testLine
      }
    }
    if (line) {
      checkPageBreak()
      page.drawText(line, { x, y, size, font: f, color })
      y -= lineHeight
    }
  }

  // Title
  page.drawText('LINKEDIN PROFILE', {
    x: margin,
    y,
    size: 16,
    font: boldFont,
    color: linkedInBlue,
  })
  y -= 8
  page.drawLine({
    start: { x: margin, y },
    end: { x: 595 - margin, y },
    thickness: 2,
    color: linkedInBlue,
  })
  y -= 24

  // Headline
  page.drawText('HEADLINE', {
    x: margin,
    y,
    size: 12,
    font: boldFont,
    color: navy,
  })
  y -= lineHeight + 2
  drawWrapped(data.headline, margin, 11, dark, boldFont)
  y -= 16

  // About
  page.drawText('ABOUT', {
    x: margin,
    y,
    size: 12,
    font: boldFont,
    color: navy,
  })
  y -= lineHeight + 2
  const aboutParagraphs = data.about.split('\n').filter((p) => p.trim())
  for (const para of aboutParagraphs) {
    drawWrapped(para, margin, fontSize, dark)
    y -= 6
  }
  y -= 10

  // Experience
  page.drawText('EXPERIENCE', {
    x: margin,
    y,
    size: 12,
    font: boldFont,
    color: navy,
  })
  y -= lineHeight + 2
  for (let i = 0; i < data.experience.length; i++) {
    checkPageBreak()
    page.drawText(`Entry ${i + 1}`, {
      x: margin,
      y,
      size: 10,
      font: boldFont,
      color: linkedInBlue,
    })
    y -= lineHeight
    const lines = data.experience[i].split('\n').filter((l) => l.trim())
    for (const line of lines) {
      drawWrapped(line, margin, fontSize, dark)
    }
    y -= 10
  }

  // Footer
  checkPageBreak()
  page.drawText('Generated by JobReady.bg — Copy these sections to your LinkedIn profile', {
    x: margin,
    y: 40,
    size: 8,
    font,
    color: rgb(0.5, 0.5, 0.5),
  })

  const pdfBytes = await doc.save()
  return Buffer.from(pdfBytes)
}
